---
- name: Step 1 - Provision HouseScanner Infrastructure (VPC, EC2, RDS, S3)
  hosts: localhost
  connection: local
  gather_facts: True
  vars_files:
    - group_vars/env.yaml
    - group_vars/secrets.yaml
  vars:
    ansible_python_interpreter: "{{ playbook_dir }}/venv/bin/python"

  tasks:
    - name: Ensure venv exists and requirements are installed
      block:
        - name: Check if venv exists
          stat:
            path: "{{ playbook_dir }}/venv"
          register: venv_check

        - name: Create venv if it doesn't exist
          command: python3 -m venv "{{ playbook_dir }}/venv"
          when: not venv_check.stat.exists

        - name: Install/Upgrade pip in venv
          pip:
            name: pip
            state: latest
            virtualenv: "{{ playbook_dir }}/venv"

        - name: Install requirements from requirements.txt
          pip:
            requirements: "{{ playbook_dir }}/requirements.txt"
            virtualenv: "{{ playbook_dir }}/venv"
            state: present
    - name: Get git commit hash for tracking
      shell: git rev-parse --short HEAD
      args:
        chdir: ../
      register: git_commit
      changed_when: false

    - name: Set deployment image tag
      set_fact:
        deployment_image_tag: "{{ git_commit.stdout }}"

    - name: Check if infrastructure already exists
      block:
        - name: Check for existing VPC
          amazon.aws.ec2_vpc_net_info:
            region: "{{ zone }}"
            filters:
              "tag:Name": "{{ vpc_name }}"
              "tag:Environment": "{{ env }}"
          register: existing_vpc

        - name: Check for existing EC2 instance
          amazon.aws.ec2_instance_info:
            region: "{{ zone }}"
            filters:
              "tag:Name": "{{ server_name }}"
              "tag:Environment": "{{ env }}"
              instance-state-name: ["pending", "running", "stopping", "stopped"]
          register: existing_ec2

        - name: Check for existing RDS instance
          amazon.aws.rds_instance_info:
            region: "{{ zone }}"
            db_instance_identifier: "{{ db_instance_identifier }}"
          register: existing_rds
          ignore_errors: yes

        - name: Check for existing S3 bucket
          amazon.aws.s3_bucket_info:
            name: "{{ s3_bucket_name }}"
            region: "{{ s3_region }}"
          register: existing_s3
          ignore_errors: yes

    - name: Display infrastructure status
      debug:
        msg: |
          ========================================
          Step 2: AWS Infrastructure Status Check
          ========================================
          Image Tag: {{ deployment_image_tag }}
          Region: {{ zone }}
          Environment: {{ env }}
          
          Existing Resources Found:
          {% if existing_vpc.vpcs | length > 0 %}
          ‚úì VPC: {{ vpc_name }} ({{ existing_vpc.vpcs[0].vpc_id }})
          {% else %}
          ‚úó VPC: {{ vpc_name }} (will be created)
          {% endif %}
          {% if existing_ec2.instances | length > 0 %}
          ‚úì EC2: {{ server_name }} ({{ existing_ec2.instances[0].instance_id }})
          {% else %}
          ‚úó EC2: {{ server_name }} (will be created)
          {% endif %}
          {% if existing_rds.db_instances is defined and existing_rds.db_instances | length > 0 %}
          ‚úì RDS: {{ db_instance_identifier }} ({{ existing_rds.db_instances[0].db_instance_status }})
          {% else %}
          ‚úó RDS: {{ db_instance_identifier }} (will be created)
          {% endif %}
          {% if existing_s3.buckets is defined and existing_s3.buckets | length > 0 %}
          ‚úì S3: {{ s3_bucket_name }} (exists)
          {% else %}
          ‚úó S3: {{ s3_bucket_name }} (will be created)
          {% endif %}
          
          Ansible will ensure all resources exist (idempotent operation)
          ========================================

    - name: Create VPC
      amazon.aws.ec2_vpc_net:
        name: "{{ vpc_name }}"
        cidr_block: "{{ network }}"
        region: "{{ zone }}"
        state: present
        dns_hostnames: yes
        dns_support: yes
        tags:
          Name: "{{ vpc_name }}"
          Environment: "{{ env }}"
      register: vpc

    - name: Create Public Subnet 1
      amazon.aws.ec2_vpc_subnet:
        vpc_id: "{{ vpc.vpc.id }}"
        cidr: "{{ subnet_public_1 }}"
        region: "{{ zone }}"
        az: "{{ subnet_az_1 }}"
        map_public: yes
        state: present
        tags:
          Name: "{{ vpc_name }}-public-1"
          Environment: "{{ env }}"
        wait: yes
      register: subnet_public_1

    - name: Create Public Subnet 2
      amazon.aws.ec2_vpc_subnet:
        vpc_id: "{{ vpc.vpc.id }}"
        cidr: "{{ subnet_public_2 }}"
        region: "{{ zone }}"
        az: "{{ subnet_az_2 }}"
        map_public: yes
        state: present
        tags:
          Name: "{{ vpc_name }}-public-2"
          Environment: "{{ env }}"
        wait: yes
      register: subnet_public_2

    - name: Create Private Subnet 1 (for RDS)
      amazon.aws.ec2_vpc_subnet:
        vpc_id: "{{ vpc.vpc.id }}"
        cidr: "{{ subnet_private_1 }}"
        region: "{{ zone }}"
        az: "{{ subnet_az_1 }}"
        map_public: no
        state: present
        tags:
          Name: "{{ vpc_name }}-private-1"
          Environment: "{{ env }}"
        wait: yes
      register: subnet_private_1

    - name: Create Private Subnet 2 (for RDS)
      amazon.aws.ec2_vpc_subnet:
        vpc_id: "{{ vpc.vpc.id }}"
        cidr: "{{ subnet_private_2 }}"
        region: "{{ zone }}"
        az: "{{ subnet_az_2 }}"
        map_public: no
        state: present
        tags:
          Name: "{{ vpc_name }}-private-2"
          Environment: "{{ env }}"
        wait: yes
      register: subnet_private_2

    - name: Create Internet Gateway
      amazon.aws.ec2_vpc_igw:
        vpc_id: "{{ vpc.vpc.id }}"
        region: "{{ zone }}"
        state: present
        tags:
          Name: "{{ vpc_name }}-igw"
      register: igw

    - name: Create Route Table
      amazon.aws.ec2_vpc_route_table:
        vpc_id: "{{ vpc.vpc.id }}"
        region: "{{ zone }}"
        state: present
        subnets:
          - "{{ subnet_public_1.subnet.id }}"
          - "{{ subnet_public_2.subnet.id }}"
        routes:
          - dest: 0.0.0.0/0
            gateway_id: "{{ igw.gateway_id }}"
        tags:
          Name: "{{ vpc_name }}-public-rt"

    - name: Create EC2 Security Group
      amazon.aws.ec2_group:
        name: "{{ vpc_name }}-ec2-sg"
        description: "Security group for HouseScanner EC2 instance"
        vpc_id: "{{ vpc.vpc.id }}"
        region: "{{ zone }}"
        state: present
        rules:
          - proto: tcp
            ports: 22
            cidr_ip: 0.0.0.0/0
            rule_desc: "SSH access"
          - proto: tcp
            ports: 80
            cidr_ip: 0.0.0.0/0
            rule_desc: "HTTP access"
          - proto: tcp
            ports: 443
            cidr_ip: 0.0.0.0/0
            rule_desc: "HTTPS access"
          - proto: tcp
            ports: "{{ backend_port }}"
            cidr_ip: 0.0.0.0/0
            rule_desc: "Backend API"
          - proto: tcp
            ports: "{{ agents_service_port }}"
            cidr_ip: 0.0.0.0/0
            rule_desc: "Agents Service"
          - proto: tcp
            ports: "{{ client_port }}"
            cidr_ip: 0.0.0.0/0
            rule_desc: "Client PWA"
        tags:
          Name: "{{ vpc_name }}-ec2-sg"
          Environment: "{{ env }}"
      register: ec2_sg

    - name: Create RDS Security Group
      amazon.aws.ec2_group:
        name: "{{ vpc_name }}-rds-sg"
        description: "Security group for RDS PostgreSQL"
        vpc_id: "{{ vpc.vpc.id }}"
        region: "{{ zone }}"
        state: present
        rules:
          - proto: tcp
            ports: 5432
            group_id: "{{ ec2_sg.group_id }}"
            rule_desc: "PostgreSQL from EC2"
        tags:
          Name: "{{ vpc_name }}-rds-sg"
          Environment: "{{ env }}"
      register: rds_sg

    - name: Create S3 Bucket for Images
      amazon.aws.s3_bucket:
        name: "{{ s3_bucket_name }}"
        region: "{{ s3_region }}"
        state: present
        versioning: yes
        encryption: "AES256"
        public_access:
          block_public_acls: false
          block_public_policy: false
          ignore_public_acls: false
          restrict_public_buckets: false
        tags:
          Name: "{{ s3_bucket_name }}"
          Environment: "{{ env }}"
      register: s3_bucket

    - name: Set S3 Bucket CORS Policy
      community.aws.s3_cors:
        name: "{{ s3_bucket_name }}"
        state: present
        rules:
          - allowed_origins: ['*']
            allowed_methods: ['GET', 'PUT', 'POST', 'DELETE']
            allowed_headers: ['*']
            max_age_seconds: 3000

    - name: Create RDS DB Subnet Group
      amazon.aws.rds_subnet_group:
        name: "{{ db_instance_identifier }}-subnet-group"
        description: "Subnet group for HouseScanner RDS"
        region: "{{ zone }}"
        subnets:
          - "{{ subnet_private_1.subnet.id }}"
          - "{{ subnet_private_2.subnet.id }}"
        state: present
        tags:
          Name: "{{ db_instance_identifier }}-subnet-group"
          Environment: "{{ env }}"
      register: db_subnet_group

    - name: Create RDS PostgreSQL Instance (idempotent)
      amazon.aws.rds_instance:
        id: "{{ db_instance_identifier }}"
        region: "{{ zone }}"
        engine: "{{ db_engine }}"
        engine_version: "{{ db_engine_version }}"
        db_instance_class: "{{ db_instance_class }}"
        allocated_storage: "{{ db_allocated_storage }}"
        db_name: "{{ db_name }}"
        master_username: "{{ db_username }}"
        master_user_password: "{{ db_password }}"
        vpc_security_group_ids:
          - "{{ rds_sg.group_id }}"
        db_subnet_group_name: "{{ db_subnet_group.subnet_group.name }}"
        publicly_accessible: "{{ db_publicly_accessible }}"
        multi_az: "{{ db_multi_az }}"
        backup_retention_period: "{{ db_backup_retention }}"
        skip_final_snapshot: "{{ db_skip_final_snapshot }}"
        storage_encrypted: yes
        tags:
          Name: "{{ db_instance_identifier }}"
          Environment: "{{ env }}"
        state: present
        wait: yes
        apply_immediately: no  # Apply changes during maintenance window
      register: rds_instance

    - name: Get existing RDS instance info if create was skipped
      amazon.aws.rds_instance_info:
        region: "{{ zone }}"
        db_instance_identifier: "{{ db_instance_identifier }}"
      register: rds_info
      when: rds_instance.changed == false

    - name: Set RDS data for existing instance
      set_fact:
        rds_instance:
          endpoint:
            address: "{{ rds_info.db_instances[0].endpoint.address }}"
            port: "{{ rds_info.db_instances[0].endpoint.port }}"
      when: rds_instance.changed == false and rds_info.db_instances is defined and rds_info.db_instances | length > 0

    - name: Launch EC2 instance (idempotent)
      amazon.aws.ec2_instance:
        name: "{{ server_name }}"
        key_name: "{{ keypair }}"
        image_id: "{{ aws_ubuntu_ami }}"
        instance_type: "{{ server_type }}"
        region: "{{ zone }}"
        vpc_subnet_id: "{{ subnet_public_1.subnet.id }}"
        security_group: "{{ ec2_sg.group_id }}"
        wait: yes
        network:
          assign_public_ip: yes
        volumes:
          - device_name: /dev/sda1
            ebs:
              volume_size: "{{ server_volume_size }}"
              volume_type: gp3
              delete_on_termination: true
        user_data: |
          #!/bin/bash
          apt-get update
          apt-get install -y python3 python3-pip
        tags:
          Name: "{{ server_name }}"
          Environment: "{{ env }}"
          ImageTag: "{{ deployment_image_tag }}"
        state: running
        wait_timeout: 500
      register: ec2_data

    - name: Get EC2 instance info if it already existed
      amazon.aws.ec2_instance_info:
        region: "{{ zone }}"
        filters:
          "tag:Name": "{{ server_name }}"
          "tag:Environment": "{{ env }}"
          instance-state-name: ["pending", "running"]
      register: ec2_info
      when: ec2_data.instances | length == 0

    - name: Set EC2 data for existing instance
      set_fact:
        ec2_data: 
          instances: "{{ ec2_info.instances }}"
      when: ec2_data.instances | length == 0 and ec2_info.instances | length > 0

    - name: Save infrastructure outputs to file
      copy:
        content: |
          # HouseScanner Infrastructure Outputs - Step 1 Complete
          # Generated on {{ ansible_date_time.iso8601 }} (Idempotent Run)
          # Docker Image Tag: {{ deployment_image_tag }}
          
          # INFRASTRUCTURE STATUS
          {% if vpc.changed is defined and vpc.changed %}VPC_STATUS=CREATED{% else %}VPC_STATUS=EXISTING{% endif %}
          {% if ec2_data.changed is defined and ec2_data.changed %}EC2_STATUS=CREATED{% else %}EC2_STATUS=EXISTING{% endif %}
          {% if rds_instance.changed is defined and rds_instance.changed %}RDS_STATUS=CREATED{% else %}RDS_STATUS=EXISTING{% endif %}
          {% if s3_bucket.changed is defined and s3_bucket.changed %}S3_STATUS=CREATED{% else %}S3_STATUS=EXISTING{% endif %}
          
          # EC2 Instance
          EC2_PUBLIC_IP={{ ec2_data.instances[0].public_ip_address }}
          EC2_INSTANCE_ID={{ ec2_data.instances[0].instance_id }}
          EC2_INSTANCE_TYPE={{ server_type }}
          
          # RDS Database
          RDS_ENDPOINT={{ rds_instance.endpoint.address }}
          RDS_PORT={{ rds_instance.endpoint.port }}
          RDS_ENGINE={{ db_engine }}
          RDS_VERSION={{ db_engine_version }}
          
          # VPC & Networking
          VPC_ID={{ vpc.vpc.id }}
          VPC_CIDR={{ network }}
          PUBLIC_SUBNET_1_ID={{ subnet_public_1.subnet.id }}
          PUBLIC_SUBNET_2_ID={{ subnet_public_2.subnet.id }}
          PRIVATE_SUBNET_1_ID={{ subnet_private_1.subnet.id }}
          PRIVATE_SUBNET_2_ID={{ subnet_private_2.subnet.id }}
          INTERNET_GATEWAY_ID={{ igw.gateway_id }}
          EC2_SECURITY_GROUP_ID={{ ec2_sg.group_id }}
          RDS_SECURITY_GROUP_ID={{ rds_sg.group_id }}
          
          # S3 Storage
          S3_BUCKET_NAME={{ s3_bucket_name }}
          S3_REGION={{ s3_region }}
          
          # Application Configuration
          DOCKER_IMAGE_TAG={{ deployment_image_tag }}
          ENVIRONMENT={{ env }}
          
          # Connection URLs for Step 3
          SSH_COMMAND=ssh -i ~/.ssh/{{ keypair }}.pem ubuntu@{{ ec2_data.instances[0].public_ip_address }}
          PSQL_COMMAND=psql -h {{ rds_instance.endpoint.address }} -U {{ db_username }} -d {{ db_name }}
        dest: ../infrastructure_outputs.txt
      delegate_to: localhost

    - name: Wait for SSH to be ready
      wait_for:
        host: "{{ ec2_data.instances[0].public_ip_address }}"
        port: 22
        timeout: 300

    - name: Display infrastructure summary
      debug:
        msg: |
          ========================================
          AWS Infrastructure Ready! (Idempotent Run Complete)
          ========================================
          
          üèóÔ∏è  INFRASTRUCTURE STATUS:
          {% if vpc.changed is defined and vpc.changed %}
          ‚úÖ VPC: {{ vpc_name }} - CREATED
          {% else %}
          ‚ôªÔ∏è  VPC: {{ vpc_name }} - ALREADY EXISTS
          {% endif %}
          
          {% if ec2_data.changed is defined and ec2_data.changed %}
          ‚úÖ EC2: {{ server_name }} - CREATED
          {% else %}
          ‚ôªÔ∏è  EC2: {{ server_name }} - ALREADY EXISTS
          {% endif %}
          
          {% if rds_instance.changed is defined and rds_instance.changed %}
          ‚úÖ RDS: {{ db_instance_identifier }} - CREATED
          {% else %}
          ‚ôªÔ∏è  RDS: {{ db_instance_identifier }} - ALREADY EXISTS
          {% endif %}
          
          {% if s3_bucket.changed is defined and s3_bucket.changed %}
          ‚úÖ S3: {{ s3_bucket_name }} - CREATED
          {% else %}
          ‚ôªÔ∏è  S3: {{ s3_bucket_name }} - ALREADY EXISTS
          {% endif %}
          
          üåê NETWORK DETAILS:
          - VPC ID: {{ vpc.vpc.id }}
          - Network: {{ network }}
          - Public Subnets: 2 ({{ subnet_az_1 }}, {{ subnet_az_2 }})
          - Private Subnets: 2 (RDS)
          
          üíª EC2 INSTANCE:
          - Public IP: {{ ec2_data.instances[0].public_ip_address }}
          - Instance ID: {{ ec2_data.instances[0].instance_id }}
          - Type: {{ server_type }}
          - SSH Ready: Yes
          
          üóÑÔ∏è  DATABASE:
          - Endpoint: {{ rds_instance.endpoint.address }}
          - Port: {{ rds_instance.endpoint.port }}
          - Engine: {{ db_engine }} {{ db_engine_version }}
          
          üì¶ STORAGE:
          - S3 Bucket: {{ s3_bucket_name }}
          - CORS: Configured for web access
          
          ‚úÖ IDEMPOTENCY: This playbook can be run multiple times safely
          ‚úÖ NO DUPLICATES: Existing resources are detected and preserved
          
          üìÑ Infrastructure outputs saved to: ../infrastructure_outputs.txt
          üöÄ Ready for Step 2 - Build Images with correct API URLs!
          ========================================