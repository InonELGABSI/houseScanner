name: ðŸš€ Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all images'
        required: false
        default: 'false'
        type: boolean

env:
  IMAGE_TAG: ${{ github.sha }}

jobs:
  step2-build-images:
    name: ðŸ—ï¸ Step 2 - Build & Push Images
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install Ansible
      run: |
        python -m pip install --upgrade pip
        pip install ansible
        
    - name: ï¿½ Read infrastructure outputs
      run: |
        if [ -f "infrastructure_outputs.txt" ]; then
          cat infrastructure_outputs.txt
          echo "EC2_IP=$(grep 'ec2_public_ip:' infrastructure_outputs.txt | cut -d' ' -f2)" >> $GITHUB_ENV
        else
          echo "EC2_IP=${{ secrets.EC2_HOST }}" >> $GITHUB_ENV
        fi
        
    - name: ðŸ³ Login to DockerHub
      run: |
        echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin
        
    - name: ðŸ—ï¸ Step 2 - Build and Push Images
      working-directory: ./ansible
      run: |
        ansible-playbook step2-build-images.yml \
          -e "dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
          -e "dockerhub_password=${{ secrets.DOCKERHUB_TOKEN }}" \
          -e "image_tag=${{ env.IMAGE_TAG }}" \
          -e "ec2_public_ip=${{ env.EC2_IP }}"

  step3-deploy:
    name: ðŸš€ Step 3 - Deploy to EC2
    runs-on: ubuntu-latest
    needs: step2-build-images
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install Ansible
      run: |
        python -m pip install --upgrade pip
        pip install ansible
        
    - name: ðŸ”‘ Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_PRIVATE_KEY }}" > ~/.ssh/housescanner-key.pem
        chmod 600 ~/.ssh/housescanner-key.pem
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
        
    - name: ðŸ“‚ Create inventory file
      working-directory: ./ansible
      run: |
        cat > inventory.yml << EOF
        all:
          hosts:
            production:
              ansible_host: ${{ secrets.EC2_HOST }}
              ansible_user: ubuntu
              ansible_ssh_private_key_file: ~/.ssh/housescanner-key.pem
              ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
        EOF
        
    - name: ðŸš€ Step 3 - Deploy Application
      working-directory: ./ansible
      run: |
        ansible-playbook -i inventory.yml step3-deploy-application.yml \
          -e "dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}" \
          -e "image_tag=${{ env.IMAGE_TAG }}"
          
    - name: âœ… Deployment Success
      run: |
        echo "ðŸŽ‰ Deployment completed successfully!"
        echo "ðŸ”– Image tag: ${{ env.IMAGE_TAG }}"
        echo "ðŸŒ Application URL: http://${{ secrets.EC2_HOST }}:8080"
        echo "ðŸ”§ Backend API: http://${{ secrets.EC2_HOST }}:3000"
        echo "ðŸ¤– Agents Service: http://${{ secrets.EC2_HOST }}:8000"

  notify:
    name: ðŸ“¢ Notify Status
    runs-on: ubuntu-latest
    needs: [step2-build-images, step3-deploy]
    if: always()
    
    steps:
    - name: ðŸ“¢ Success Notification
      if: needs.step3-deploy.result == 'success'
      run: |
        echo "âœ… Deployment successful!"
        echo "ðŸ”– Image tag: ${{ github.sha }}"
        echo "ðŸ‘¤ Author: ${{ github.actor }}"
        echo "ðŸ’¾ Commit: ${{ github.event.head_commit.message }}"
        
    - name: âŒ Failure Notification
      if: needs.step2-build-images.result == 'failure' || needs.step3-deploy.result == 'failure'
      run: |
        echo "âŒ Deployment failed!"
        echo "ðŸ”– Image tag: ${{ github.sha }}"
        echo "ðŸ‘¤ Author: ${{ github.actor }}"
        echo "ðŸ’¾ Commit: ${{ github.event.head_commit.message }}"
        if [[ "${{ needs.step2-build-images.result }}" == "failure" ]]; then
          echo "ðŸ—ï¸ Failed at: Step 2 - Build Images"
        fi
        if [[ "${{ needs.step3-deploy.result }}" == "failure" ]]; then
          echo "ðŸš€ Failed at: Step 3 - Deploy"
        fi
        exit 1